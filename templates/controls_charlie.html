{% extends "layout.html" %}

{% block extra_css %}
<style>
    .control-panel {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        max-width: 500px;
        margin: 0 auto;
    }

    .game-info {
        background: white;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 2rem;
        text-align: center;
        font-size: 1.2em;
    }

    .current-player {
        margin-bottom: 1rem;
        color: #1a237e;
        font-weight: bold;
    }

    .game-timer {
        color: #2e7d32;
        font-size: 1.3em;
        font-weight: bold;
    }

    .button-group {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 2rem;
    }

    .btn {
        padding: 1rem 2rem;
        border: none;
        border-radius: 5px;
        font-size: 1.2em;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn:active:not(:disabled) {
        transform: scale(0.95);
    }

    .btn-start {
        background: #ffc107;  /* Colore Charlie */
        color: black;
    }

    .btn-stop {
        background: #f44336;
        color: white;
    }

    .btn-next {
        background: #ffc107;  /* Colore Charlie */
        color: black;
        width: 100%;
        margin-bottom: 1rem;
    }

    .btn-start:hover:not(:disabled) {
        background: #e0a800;
    }

    .btn-stop:hover:not(:disabled) {
        background: #da190b;
    }

    .btn-next:hover:not(:disabled) {
        background: #e0a800;
    }

    .status {
        text-align: center;
        margin-top: 2rem;
        font-size: 1.2em;
    }
</style>
{% endblock %}

{% block content %}
<h1>Controllo CHARLIE</h1>

<div class="game-info">
    <div class="current-player">
        Prenotazione in gioco: <span id="current-player">-</span>
    </div>
    <div class="game-timer">
        Tempo trascorso: <span id="timer">00:00</span>
    </div>
</div>

<div class="control-panel">
    <button id="next-player-btn" class="btn btn-next" onclick="activateNextPlayer()" disabled>
        Prossimo Giocatore
    </button>
    <div class="button-group">
        <button id="start-btn" class="btn btn-start" onclick="pressButton('charlie_start')">START</button>
        <button id="stop-btn" class="btn btn-stop" onclick="pressButton('charlie_stop')">STOP</button>
    </div>
    <div class="status">
        Stato: <span id="status">Inattivo</span>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let timerInterval;
    let startTime;
    let isGameActive = false;

    function updateNextPlayer() {
        if ($('#current-player').text() !== '-' && !$('#next-player-btn').prop('disabled')) {
            return;
        }

        fetch('/simulate')
            .then(response => response.json())
            .then(data => {
                if (data.charlie && data.charlie.length > 0) {
                    const playerId = data.charlie[0][1];  // Ora sarÃ  nel formato VERDE-XX
                    $('#current-player').text(playerId);
                    $('#next-player-btn').prop('disabled', false);
                } else {
                    $('#current-player').text('-');
                    $('#next-player-btn').prop('disabled', true);
                }
            });
    }

    function updateAvailability() {
        $.get('/get_status', function(data) {
            const canStart = data.charlie_status === 'Libera';
            $('#start-btn').prop('disabled', !canStart);
            $('#status').text(data.charlie_status + ' - ' + data.charlie_remaining);
            
            if (!canStart) {
                $('#start-btn').attr('title', 'Attendere che la pista CHARLIE sia libera');
            } else {
                $('#start-btn').attr('title', '');
            }
            updateNextPlayer();
        });
    }

    function updateTimer() {
        if (!isGameActive) return;
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
        const seconds = (diff % 60).toString().padStart(2, '0');
        $('#timer').text(`${minutes}:${seconds}`);
    }

    function activateNextPlayer() {
        $('#next-player-btn').prop('disabled', true);
        $('#stop-btn').prop('disabled', false);
        $('#timer').text('00:00');
        $('#current-player').text('-');
        updateAvailability();
    }

    function pressButton(button) {
        $.ajax({
            url: '/button_press',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({button: button}),
            success: function(response) {
                if (!response.success) {
                    alert(response.error);
                    return;
                }
                
                if (button === 'charlie_start') {
                    startTime = new Date();
                    isGameActive = true;
                    timerInterval = setInterval(updateTimer, 1000);
                    $('#next-player-btn').prop('disabled', true);
                    $('#start-btn').prop('disabled', true);
                    $('#stop-btn').prop('disabled', false);
                } else if (button === 'charlie_stop') {
                    isGameActive = false;
                    clearInterval(timerInterval);
                    $('#next-player-btn').prop('disabled', false);
                    $('#start-btn, #stop-btn').prop('disabled', true);
                }
                
                // updateAvailability();
            }
        });
    }

    function updateStatus() {
        $.get('/get_status', function(data) {
            $('#status').text(data.charlie_status + ' - ' + data.charlie_remaining);
        });
    }

    function skipPlayer() {
        const currentPlayer = $('#current-player').text();
        if (currentPlayer !== '-') {
            fetch('/skip_charlie_player', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: currentPlayer })
            })
            .then(response => response.json())
            .then(() => {
                // Dopo lo skip, aggiorna immediatamente per mostrare il prossimo giocatore dello stesso tipo
                fetch('/simulate')
                    .then(response => response.json())
                    .then(data => {
                        // Cerca il prossimo giocatore di tipo charlie (verde)
                        if (data.charlie && data.charlie.length > 0) {
                            $('#current-player').text(data.charlie[0][1]);
                            $('#next-player-btn').prop('disabled', false);
                        } //else {
                        //     $('#current-player').text('-');
                        //     $('#next-player-btn').prop('disabled', true);
                        // }
                    });
            });
        }
    }

    // Aggiorna lo stato ogni secondo
    setInterval(updateStatus, 1000);
    //setInterval(updateAvailability, 1000);
    
    $(document).ready(function() {
        updateStatus();
        updateAvailability();
    });
</script>
{% endblock %} 